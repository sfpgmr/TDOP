<!DOCTYPE HTML>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="keywords" content="JavaScript,wasm">
    <meta name="description" content="オレオレ言語を作る">
    <meta name="author" content="SFPGMR">
    <title>オレオレ言語を作る</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/siimple@3.0.0/dist/siimple.min.css">
    <style>
        .OUTPUT {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
    <script type="text/javascript">
        if (!window.location.hostname.match(/localhost/)) {
            (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-15457703-9', 'auto');
            ga('send', 'pageview');
        }
    </script>
</head>

<body class="siimple-content siimple-content--medium">
    <div class="siimple-box siimple-box--blue">
        <h1 class="siimple-box-title">オレオレ言語を作る</h1>
        <p class- "siimple-box-detail">レポジトリ：
            <a href="https://github.com/sfpgmr/sgl2" class="siimple-link">https://github.com/sfpgmr/sgl2</a>
    </div>
    <h3>
        <label class="siimple-label">Input Source Code </label>
    </h3>
    <textarea id="INPUT" class="siimple-box siimple-box--fluid" rows="10"></textarea>
    <button id="Compile" value="parse" type="button" class="siimple-btn siimple-btn--blue">Compile</button>
    <pre id="info"></pre>
    <h2>
        <label class="siimple-label">Output(AST)</label>
    </h2>
    <pre id=OUTPUT class="siimple-box OUTPUT"></pre>
    <h2>
        <label class="siimple-label">Output(wat)</label>
    </h2>
    <pre id=OUTPUT2 class="siimple-box OUTPUT"></pre>
    <h2>
        <label class="siimple-label">Output</label>
    </h2>
    <pre id=OUTPUT3 class="siimple-box OUTPUT"></pre>
    <script type="module">

        import tokenize from './tokens.mjs';
        import make_parse from './parse.mjs';
        import generateCode from './generateCode.mjs';


        const src = `
export i32 main(){
  i32 b = 0;

  for(i32 c = 0;c < 4;++c) {
    b = b + 1;
  }
  return b;// 4
}
`;

        document.getElementById('INPUT').value = src;
        window.addEventListener('load', () => {
            const parse = make_parse();
            const output =  document.getElementById('OUTPUT');
            const output2 = document.getElementById('OUTPUT2');
            const output3 = document.getElementById('OUTPUT3');
            const info = document.getElementById('info');
            

            async function go(source) {
                output.innerHTML = output2.innerHTML = output3.innerHTML = info.innerHTML = '';
                info.className = '';
                let string, ast;
                let error = false;
                try {
                    ast = parse(tokenize(source));
                    string = JSON.stringify(ast,
                        (key, value) => {
                            if (key == 'parent') return undefined;
                            return value;
                        }
                        , 2);
                    output.innerHTML = string
                        .replace(/&/g, '&amp;')
                        .replace(/[<]/g, '&lt;');
                    const module = generateCode(ast);
                    module.optimize();
                    const wat = module.emitText();
                    output2.innerHTML = wat
                        .replace(/&/g, '&amp;')
                        .replace(/[<]/g, '&lt;');

                    const compiled = module.emitBinary();

                    const mod = await WebAssembly.compile(compiled);
                    const instance = await WebAssembly.instantiate(mod);
                    const result = instance.exports.main().toString(10);
                    output3.innerHTML = result
                        .replace(/&/g, '&amp;')
                        .replace(/[<]/g, '&lt;');

                } catch (e) {
                    string = e.stack ? e.stack : JSON.stringify(e,
                        (key, value) => {
                            if (key == 'parent') return undefined;
                            return value;
                        }
                        , 2);
                                       
                    info.innerHTML = string.replace(/&/g, '&amp;')
                        .replace(/[<]/g, '&lt;');
                    ;
                    info.className = 'siimple-alert siimple-alert--red';

                }

            }

            go(src);

            document.getElementById('Compile').onclick = function (e) {
                go(document.getElementById('INPUT').value);
            };

        });


    </script>
</body>

</html>